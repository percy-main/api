version: v1.0
name: Percy Main Match Fees
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:
  # - name: Test & Build
  #   task:
  #     jobs:
  #       - name: Test & Build
  #         commands:
  #           - checkout
  #           - sem-version node 16
  #           - cache restore
  #           - yarn install
  #           - cache store
  #           - yarn lint
  #           - yarn test
  #           - test-results publish junit.xml
  #           - yarn build

  - name: Migrations
    run:
      when: "branch = 'master'"
    task:
      secrets:
        - name: database-url
        - name: fly-io-api-token
      jobs:
        - name: Apply DB migrations
          commands:
            - checkout
            - curl -L https://fly.io/install.sh | sh
            - /home/semaphore/.fly/bin/flyctl proxy 5432 -a match-fees-db
            - |
              docker run \
              -v "$PWD/./migrations:/flyway/sql/migrations" \
              flyway/flyway:9.8.1 \
              -url=jdbc:"$DATABASE_URL" \
              -connectRetries=10 \
              migrate

  - name: Deploy
    run:
      when: "branch = 'master'"
    task:
      secrets:
        - name: fly-io-api-token
      jobs:
        - name: Deploy to matchfees.percymain.org
          commands:
            - checkout
            - curl -L https://fly.io/install.sh | sh
            - /home/semaphore/.fly/bin/flyctl deploy
